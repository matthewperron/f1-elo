# F1 Elo Project - Agent Instructions

## Project Overview

This is an F1 driver strength calculation project that computes Elo ratings for all Formula 1 drivers (historical and current) using the chess Elo algorithm.

## Key Concepts

### Elo System
- **Three separate Elo scores per driver**: Qualifying Elo, Race Elo, and Global Elo
- **Teammate-only comparison**: Drivers are only compared against their teammates
- **Classic chess Elo formula**: Standard expected score and K-factor calculations (K=64)
- **Global Elo calculation**: Combines qualifying (30%) and race (70%) performance
- **Chronological processing**: Race history must be sorted by date for accurate progression

### Data Requirements
- **Main data file**: `f1-historical-race-results.json` (generated by update script)
- **Data source**: Ergast API (https://api.jolpi.ca/ergast/f1/)
- **Data exclusions**: Skip races where no teammate participated or either driver had DNF
- **Required fields**: Driver names, teams, qualifying positions, race results, dates
- **Rate limiting**: 2 seconds between API calls to avoid hitting limits

### Output Files and Generation
- **Four main page types are generated**:
  - **Home page** (`docs/index.md`): Generated by `bulk-calculate.js` (top 30 tables) and `calculate-elo.js` (current season)
    - Contains season navigation table with F1.com links for official results
    - Top 30 driver tables include season navigation links within each table
  - **Driver pages** (`docs/cleanDriverName.md`): Generated by `bulk-calculate.js`
    - Results split by season with season-specific headers and anchors
    - Quick season navigation at top with links to season reports and F1.com
    - Each season section includes link to full season report
  - **Season pages** (`docs/YYYY-season-report.md`): Generated by `calculate-elo.js`
    - Quick navigation to all races within the season at top
    - Links to F1.com and Wikipedia for complete season data
    - F1.com links added next to final ELO ratings table
  - **Peak Elo page** (`docs/peak-elo.md`): Generated by `bulk-calculate.js`
- **README update**: Elo results table automatically inserted between `<!-- ELO_RESULTS_START -->` and `<!-- ELO_RESULTS_END -->` comments
- **Data fetching**: `fetch-results.js` calls external API, writes raw data to `raw/` folder and processed data to `data/` folder

## Project Structure

```
f1-elo/
├── data/
│   ├── 2024-race-results.json         # 2024 season race data and final Elos
│   ├── 2023-race-results.json         # 2023 season race data and final Elos
│   └── ...                            # Historical data (1950-2025)
├── docs/                              # the markdown output for GitHub Pages
├── raw-data/                          # Raw API cache from Ergast API
├── main.js                            # Main orchestration script with Elo calculation
├── bulk-calculate.js                  # Bulk processing for historical data and driver/peak pages
├── calculate-elo.js                   # Single season processing and season report generation
├── fetch-results.js                   # Data fetching from Ergast API
├── cache-manager.js                   # Cache management utilities
├── package.json                       # Node.js dependencies
└── README.md                          # Project documentation with results table
```

## Development Guidelines

### Data Processing
1. Parse race results from JSON file
2. Sort races chronologically by date
3. Group drivers by team for each race
4. Calculate Elo changes for qualifying and race separately
5. Exclude invalid comparisons (no teammate, DNF, etc.)

### Elo Calculation Rules
- **Initial rating**: All drivers start with 1500 Elo (or carry over from previous season)
- **Head-to-head only**: Compare qualifying/race positions between teammates
- **K-factor**: Determines rating change magnitude (64)
- **Expected score**: Based on Elo difference between teammates
- **Actual score**: 1 for win, 0 for loss in head-to-head comparison
- **Global Elo**: Combines qualifying (30%) and race (70%) performance into a comprehensive rating
- **Multi-teammate scaling**: When drivers have multiple teammates, Elo changes are scaled by 1/(N-1) where N is the number of drivers on the team to ensure fair rating distribution

### Commands
- `npm start` - Calculate Elo for 2025 season data (default) and update README
- `npm run calculate -- YYYY` - Fetch specific season data and recalculate ratings
- `npm run elo-only` - Calculate Elo from existing data files (no fetching)
- `npm run elo-only -- YYYY` - Calculate Elo for specific year from existing data
- `npm run fetch-only -- YYYY` - Fetch specific season data only

## Implementation Notes

- Use JavaScript/TypeScript for the calculation script
- Ensure proper error handling for missing data
- Consider performance for large historical datasets
- Maintain separate tracking for qualifying vs race performance
- Results should be sorted by Elo rating (highest first)

## Agent Guidelines

- **Terminology**: 
  - Always use "Elo" (not "ELO" or "elo") in documentation and comments. Code variables can remain as-is, but prefer "elo" for camelCase variables.
  - Use "Global" (not "Overall") to refer to the combined 30% qualifying + 70% race Elo rating throughout the project
  - Specify Elo type clearly: "Qualifying Elo", "Race Elo", "Global Elo" when referring to peak/lowest ratings
- **Elo Display Format**:
  - Always display Elo scores using the standard format: "FINAL_ELO [arrow] DELTA"
  - Use `formatEloWithDelta(finalElo, eloChange)` function for consistent formatting
  - Green color for positive changes (▲), red for negative changes (▼), neutral for zero (↔)
  - Example: "1650 ▲ +25" (green), "1625 ▼ -15" (red), "1500 ↔ 0" (neutral)
  - Function returns HTML with inline styling for color coding
- **File restrictions**: 
  - Do NOT read or edit files under `docs/` folder - they are massive generated files that will consume excessive tokens
  - Do NOT read or edit files under `raw-data/` folder - they are also massive and will consume excessive tokens
  - ASK before interacting with files under `data/` folder - they are also large and can consume many tokens
- **Generated content**: All markdown pages under `docs/` are automatically generated by the scripts and should not be manually edited
- **GitHub Pages links**: The project outputs to GitHub Pages, so internal links should NOT include ".md" extensions or GitHub Pages won't work properly. Always double-check that links work correctly in the final output.
- **Maintaining AGENT.md**: Any project structure changes, new scripts, changes to where files are generated, or other modifications that could help future agents should be documented in this AGENT.md file.
